<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PolyBubbles: Pro Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        :root { 
            --poly-bg: #030816; --poly-blue: #2458f0; --poly-blue-glow: rgba(36, 88, 240, 0.4);
            --poly-green: #00d395; --poly-red: #ff4a5a; --poly-text: #ffffff;
        }
        body { 
            margin: 0; background: var(--poly-bg); overflow: hidden; 
            font-family: 'Inter', sans-serif; color: var(--poly-text);
            background-image: radial-gradient(circle at 20% 20%, #0a132e 0%, #030816 100%);
        }
        .header {
            position: absolute; top: 0; left: 0; right: 0; padding: 14px 24px;
            background: rgba(3, 8, 22, 0.8); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.08); z-index: 100;
            display: flex; justify-content: space-between; align-items: center; pointer-events: none;
        }
        .header * { pointer-events: auto; }
        .logo-wrapper { display: flex; align-items: center; text-decoration: none; }
        
        /* АНИМАЦИЯ ПАРЕНИЯ */
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* ОГРОМНЫЙ ЛОГОТИП С ЭФФЕКТАМИ */
        .custom-logo {
            width: 240px; 
            height: 240px; 
            object-fit: contain;
            filter: drop-shadow(0 0 20px var(--poly-blue-glow));
            opacity: 0.95; 
            transition: all 0.3s ease;
            cursor: pointer;
            margin-left: 10px;
            /* Применяем парение */
            animation: floating 4s infinite ease-in-out;
        }
        .custom-logo:hover { 
            opacity: 1; 
            transform: scale(1.05);
            animation-play-state: paused; /* Остановить парение при наведении */
        }

        .timeframes { display: flex; gap: 6px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 10px; }
        .tf-btn {
            background: transparent; border: none; color: rgba(255,255,255,0.4);
            padding: 6px 14px; border-radius: 7px; cursor: pointer; font-size: 10px; 
            font-weight: 800; transition: all 0.2s;
        }
        .tf-btn.active { background: var(--poly-blue); color: white; box-shadow: 0 0 10px var(--poly-blue-glow); }

        .live-status {
            background: rgba(0, 211, 149, 0.1); border: 1px solid rgba(0, 211, 149, 0.2);
            padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 8px;
        }
        .dot { width: 6px; height: 6px; background: var(--poly-green); border-radius: 50%; box-shadow: 0 0 8px var(--poly-green); }
        .status-text { font-size: 10px; font-weight: 600; color: var(--poly-green); text-transform: uppercase; }
        
        svg { display: block; width: 100vw; height: 100vh; }
        @keyframes pulse-leader { 0% { opacity: 0.4; } 50% { opacity: 0.9; } 100% { opacity: 0.4; } }
        .leader-glow { animation: pulse-leader 2s infinite ease-in-out; }
        .bubble-ui { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; pointer-events: none; width: 100%; height: 100%; }
        .title { font-weight: 400; color: #fff; margin-bottom: 2px; padding: 0 4px; }
        .value { font-weight: 800; color: #fff; line-height: 1; }
        .volume { font-weight: 600; opacity: 0.5; margin-top: 1px; }
    </style>
</head>
<body>
<div class="header">
    <div class="logo-wrapper">
        <img src="logo.png" alt="Logo" class="custom-logo" onclick="window.location.reload()">
    </div>
    <div class="timeframes">
        <button class="tf-btn active" onclick="changeTF('24h', this)">24H</button>
        <button class="tf-btn" onclick="changeTF('7d', this)">7D</button>
        <button class="tf-btn" onclick="changeTF('all', this)">ALL</button>
    </div>
    <div class="live-status"><div class="dot"></div><span class="status-text" id="sync-info">Syncing...</span></div>
</div>
<script>
    const width = window.innerWidth, height = window.innerHeight, topPadding = 120;
    const svg = d3.select("body").append("svg").attr("width", width).attr("height", height);
    const defs = svg.append("defs");
    let nodes = [];
    let currentTF = '24h';

    const createGrad = (id, color) => {
        const grad = defs.append("radialGradient").attr("id", id).attr("cx", "40%").attr("cy", "40%");
        grad.append("stop").attr("offset", "0%").attr("stop-color", "#ffffff").attr("stop-opacity", 0.4);
        grad.append("stop").attr("offset", "100%").attr("stop-color", color).attr("stop-opacity", 0.3);
    };
    createGrad("grad-green", "#00d395"); createGrad("grad-blue", "#2458f0"); createGrad("grad-red", "#ff4a5a");

    const simulation = d3.forceSimulation(nodes)
        .force("charge", d3.forceManyBody().strength(5))
        .force("x", d3.forceX(width / 2).strength(0.015))
        .force("y", d3.forceY((height + topPadding) / 2).strength(0.015))
        .force("collide", d3.forceCollide().radius(d => d.radius + 12).iterations(15))
        .alphaTarget(0.15)
        .on("tick", () => {
            nodes.forEach(d => {
                d.vx += (Math.random() - 0.5) * 0.15; d.vy += (Math.random() - 0.5) * 0.15;
                d.x = Math.max(d.radius + 20, Math.min(width - d.radius - 20, d.x));
                d.y = Math.max(d.radius + topPadding, Math.min(height - d.radius - 20, d.y));
            });
            svg.selectAll(".bubble-group").attr("transform", d => `translate(${d.x},${d.y})`);
        });

    function changeTF(tf, btn) {
        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTF = tf;
        updateData();
    }

    function render(newData) {
        const screenArea = width * (height - topPadding);
        const maxBubbles = Math.floor(screenArea / 18000); 
        
        const filteredData = newData.sort((a, b) => b.pnl - a.pnl).slice(0, Math.min(maxBubbles, 40));
        const totalVolume = d3.sum(filteredData, d => d.pnl);
        const maxVol = d3.max(filteredData, d => d.pnl) || 1000;
        const avgVol = d3.mean(filteredData, d => d.pnl) || 500;

        const radiusScale = d3.scalePow()
            .exponent(0.6)
            .domain([0, maxVol])
            .range([10, 75]); 

        const activeLabels = filteredData.map(d => d.label);
        nodes = nodes.filter(n => activeLabels.includes(n.label));

        filteredData.forEach(d => {
            let node = nodes.find(n => n.label === d.label);
            const r = radiusScale(d.pnl);
            const s = ((d.pnl / totalVolume) * 100).toFixed(1) + "%";
            if (node) { node.pnl = d.pnl; node.radius = r; node.share = s; }
            else { nodes.push({ ...d, radius: r, x: Math.random()*width, y: Math.random()*height, share: s }); }
        });

        const maxVolValue = d3.max(nodes, d => d.pnl);
        const bubbles = svg.selectAll(".bubble-group").data(nodes, d => d.label);
        bubbles.exit().remove();

        const gEnter = bubbles.enter().append("g").attr("class", "bubble-group")
            .call(d3.drag()
                .on("start", (e, d) => { d.startX = e.x; d.startY = e.y; d.fx = d.x; d.fy = d.y; })
                .on("drag", (e, d) => { d.fx = e.x; d.fy = e.y; })
                .on("end", (e, d) => {
                    d.fx = null; d.fy = null;
                    const dist = Math.sqrt(Math.pow(e.x - d.startX, 2) + Math.pow(e.y - d.startY, 2));
                    if (dist < 6) window.open(d.link, "_blank");
                })
            );

        gEnter.append("circle").attr("class", "glow").style("filter", "blur(12px)");
        gEnter.append("circle").attr("class", "main-circle");
        const foreign = gEnter.append("foreignObject").attr("class", "text-box");
        const div = foreign.append("xhtml:div").attr("class", "bubble-ui");
        div.append("div").attr("class", "title");
        div.append("div").attr("class", "value");
        div.append("div").attr("class", "volume");

        const all = svg.selectAll(".bubble-group");
        const hT = avgVol * 1.15, mT = avgVol * 0.85;

        all.select(".glow").attr("r", d => d.pnl === maxVolValue ? d.radius + 15 : d.radius + 6)
            .attr("fill", d => d.pnl >= hT ? "#00d395" : (d.pnl >= mT ? "#2458f0" : "#ff4a5a"))
            .classed("leader-glow", d => d.pnl === maxVolValue);

        all.select(".main-circle").attr("r", d => d.radius)
            .attr("stroke", d => d.pnl === maxVolValue ? "#fff" : "none").attr("stroke-width", 2)
            .attr("fill", d => d.pnl >= hT ? "url(#grad-green)" : (d.pnl >= mT ? "url(#grad-blue)" : "url(#grad-red)"));

        all.select(".text-box").attr("x", d => -d.radius).attr("y", d => -d.radius).attr("width", d => d.radius * 2).attr("height", d => d.radius * 2);
        
        all.select(".title")
            .style("font-size", d => Math.max(6, d.radius * 0.23) + "px")
            .text(d => d.radius < 26 ? "" : (d.label.length > 18 ? d.label.slice(0, 16) + '..' : d.label));

        all.select(".value")
            .style("font-size", d => Math.max(8, d.radius * 0.45) + "px")
            .text(d => d.share);

        all.select(".volume")
            .style("display", d => d.radius < 35 ? "none" : "block")
            .style("font-size", d => Math.max(5, d.radius * 0.18) + "px")
            .text(d => {
                if (d.pnl >= 1000) return (d.pnl / 1000).toFixed(1) + "K VOL";
                return Math.round(d.pnl) + " VOL";
            });

        simulation.nodes(nodes).alpha(1).restart();
    }

    async function updateData() {
        try {
            const r = await fetch(`/api?t=${currentTF}`); 
            const d = await r.json();
            if (d.length > 0) {
                document.getElementById('sync-info').innerText = "LIVE: " + new Date().toLocaleTimeString();
                render(d);
            }
        } catch (e) { console.error(e); }
    }
    updateData(); setInterval(updateData, 20000);
</script>
</body>
</html>